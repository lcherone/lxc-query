dist: trusty
sudo: yes
language: node_js
node_js:
  - "node"
cache:
  directories:
    - "node_modules"
before_install:
  - npm i -g standard
  - npm i -g mocha
install:
  - travis_retry npm install
script:
  # exit on fail
  - set -eo pipefail
  # setup LXD group
  - sudo groupadd --system lxd
  - sudo usermod -a -G lxd $USER
  # install lxd
  - sudo apt-get --yes install snapd
  - sudo snap install lxd
  # create profile
  - sudo lxd waitready
  - sudo lxd init --auto --network-address="127.0.0.1" --storage-backend=dir --trust-password=123456
  #- sudo lxd.lxc profile copy default travis
  #- sudo lxd.lxc profile set travis security.privileged true
  # launch image
  #- sudo lxd.lxc launch images:alpine/3.5 alpine --profile travis
  # mount current dir into container
  #- sudo lxd.lxc config device add alpine travis disk source="$PWD" path=/travis
  #- sudo lxd.lxc exec alpine -- ls -al /travis
  # try network inside container
  #- sleep 5
  #- sudo lxd.lxc exec alpine -- ping github.com -c 2
  # try LXD REST api
  - openssl genrsa 2048 > client.key
  - openssl req -new -x509 -nodes -sha1 -days 365 -key client.key -out client.crt -subj "/C=GB/ST=London/L=London/O=TEST/OU=IT Department/CN=ssl.cherone.co.uk"
  - sudo lxd.lxc config trust add client.crt
  - curl -k -L --cert client.crt --key client.key "https://127.0.0.1:8443/1.0"
  - sudo lxd.lxc query -X GET -d '{}' 'local:/1.0'
  - export PATH=./node_modules/.bin:/usr/bin:/bin:/snap/bin:$PATH
  - npm run test